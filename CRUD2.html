<!DOCTYPE html>
<html>

<head>
    <title>CRUD 2</title>
    <style>
        .delete,
        .edit {
            width: 35px;
        }

        .hidden {
            display: none !important;
        }

        table,
        td,
        th {
            border: 2px solid black;
        }
    </style>
    <script>
        // CRUD = Create, Read, Update, Delete;
        let url = "https://crud-956c2.europe-west1.firebasedatabase.app/CamiBaraian/"
        let inregistrari = {};
        let indexEditare = -1;

        async function getInregistrari() {
            //const response = await fetch(url+".json");
            //inregistrari = await response.json();
            inregistrari = await ajax(url);
            if (inregistrari === null) {
                inregistrari = {};
            }
            draw();
        }
        async function ajax(url, method, body) {
            // loading start
            let response = await fetch(url + ".json", {
                method: method,
                body: JSON.stringify(body),
                headers: {
                    'Content-Type': 'application/json'
                },
            });
            return await response.json();
            // loading end

        }
        function draw() {
            let str = "";
            for (let [id, inregistrare] of Object.entries(inregistrari)) {
                str += `
					<tr>
						<td>${inregistrare.data}</td>
						<td><a href="${inregistrare.link}" target="_blank">Link</a></td>
						<td>${inregistrare.parola}</td>
						<td>
							<img class="delete" src="DeleteDustbin-512.png" onclick="del('${id}');" />
							<img class="edit" src="Edit_icon_(the_Noun_Project_30184).svg.png" onclick="edit('${id}');" />
						</td>
					</tr>
				`
            }
            document.querySelector("#zoom tbody").innerHTML = str;
        }
        /** 
         * Preia informatiile din array si le populeaza in formular.
        */
        function edit(idx) {
            let inregistrare = inregistrari[idx];
            document.querySelector("[name='link']").value = inregistrare.link;
            document.querySelector("[name='parola']").value = inregistrare.parola;
            document.querySelector("[name='data']").value = inregistrare.data;
            indexEditare = idx;
            document.querySelector("#editBtn").classList.remove("hidden");
            document.querySelector("#addBtn").classList.add("hidden");
            showForm();
        }
        /**
         * Preia informatiile din formular si le actualizeaza in array;
        */
        async function editPasul2() {
            if (indexEditare === -1) {
                return;
            }
            await ajax(
                url + indexEditare,
                "PUT",
                {
                    "link": document.querySelector("[name='link']").value,
                    "parola": document.querySelector("[name='parola']").value,
                    "data": document.querySelector("[name='data']").value,
                }
            );
            await getInregistrari();

            cancel();
        }
        function cancel() {
            indexEditare = -1;
            document.querySelector("#editBtn").classList.add("hidden");
            document.querySelector("#addBtn").classList.remove("hidden");
            //dupa modificarile facute, resetam formularul, dupa onclik formularul se goleste.
            document.querySelector("form").reset();
            // o alta varianta in care resetam formularul.

            //document.querySelector("[name='link']").value="";
            //document.querySelector("[name='parola']").value="";
            //document.querySelector("[name='data']").value="";
            hideForm();
        }
        async function del(idx) {
            if (confirm(`Esti sigur ca vrei sa stergi inregistrarea de la data de ${inregistrari[idx].data} ?`)) {
                await ajax(url + idx, "DELETE");
                await getInregistrari();
            }

        }
        async function adauga() {
            let link = document.querySelector("[name='link']").value;
            let parola = document.querySelector("[name='parola']").value;
            let data = document.querySelector("[name='data']").value;


            await ajax(
                url + inregistrari.length, 
                "PUT", 
                {
                "link": link,
                "parola": parola,
                "data": data
            }
            ),
            await getInregistrari();
            hideForm();
        }

        function hideForm() {
            document.querySelector("form").classList.add("hidden");
            document.querySelector("#zoom").classList.remove("hidden");
            document.querySelector("#plusBtn").classList.remove("hidden");
        }
        function showForm() {
            document.querySelector("form").classList.remove("hidden");
            document.querySelector("#zoom").classList.add("hidden");
            document.querySelector("#plusBtn").classList.add("hidden");
        }
    </script>
</head>

<body onload="getInregistrari();">
    <form onsubmit="event.preventDefault(); adauga();" class="hidden">
        <label>
            Link: <input type="text" name="link" />
        </label>
        <br />
        <label>
            Parola: <input type="password" name="parola" />
        </label>
        <br />
        <label>
            Data: <input type="date" name="data" />
        </label>
        <br />
        <input id="addBtn" type="submit" value="Adauga" />
        <input id="editBtn" type="button" onclick="editPasul2();" class="hidden" value="Editeaza" />
        <input id="cancelBtn" type="button" onclick="cancel();" value="Cancel" />
    </form>
    <input id="plusBtn" type="button" value="+" onclick="showForm();" />
    <table id="zoom" style="border-collapse: collapse;">
        <thead>
            <tr>
                <th>Data</th>
                <th>Link</th>
                <th>Parola</th>
                <th>Delete/Edit</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

</body>

</html>